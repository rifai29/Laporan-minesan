<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Kasir</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-red: #c1121c; --brand-dark: #910d14; --off-white: #f8fafc; --text-main: #1e293b; --text-muted: #94a3b8; --border-light: #f1f5f9; --success: #059669; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--off-white); color: var(--text-main); -webkit-tap-highlight-color: transparent; }

        /* Navbar */
        .navbar { background-color: #ffffff; padding: 18px 20px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border-light); }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; margin-right: 15px; color: var(--brand-red); line-height: 1; }
        .nav-title { font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Sidebar */
        .sidebar { position: fixed; left: -280px; top: 0; height: 100%; width: 280px; background: white; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1100; padding: 40px 20px; box-shadow: 10px 0 30px rgba(0,0,0,0.05); }
        .sidebar.active { left: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; z-index: 1050; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        .nav-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; color: var(--text-main); text-decoration: none; font-weight: 600; font-size: 0.9rem; border-bottom: 1px solid var(--border-light); cursor: pointer; }

        /* Main Content */
        .container { padding: 20px; max-width: 480px; margin: auto; }
        .card { background: #ffffff; border-radius: 20px; padding: 24px; margin-bottom: 20px; border-top: 5px solid var(--brand-red); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .scroll-container { max-height: 220px; overflow-y: auto; margin-top: 10px; }
        .data-row { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border-light); font-size: 0.85rem; }

        /* Form */
        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        input { width: 100%; padding: 14px; border: 1.5px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px; outline: none; font-size: 1rem; transition: 0.2s; }
        input:focus { border-color: var(--brand-red); }
        
        .btn-primary { width: 100%; padding: 16px; border: none; border-radius: 14px; background: var(--brand-red); color: white; font-weight: 700; cursor: pointer; margin-bottom: 10px; font-size: 0.9rem; }
        .btn-primary:active { background: var(--brand-dark); }
        .btn-secondary { width: 100%; padding: 16px; border: none; border-radius: 14px; background: #e2e8f0; color: var(--text-main); font-weight: 700; cursor: pointer; font-size: 0.9rem; }

        /* Custom Modal UI */
        .modal-container { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-container.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 340px; border-radius: 24px; padding: 30px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
        .modal-desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }

        .page { display: none; }
        .active-page { display: block; }
    </style>
</head>
<body>

    <div class="modal-container" id="modal-ui">
        <div class="modal-content">
            <div id="modal-title" class="modal-title"></div>
            <div id="modal-desc" class="modal-desc"></div>
            <div class="modal-actions" id="modal-buttons">
                </div>
        </div>
    </div>

    <nav class="navbar">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="nav-title" id="header-title">INPUT DATA</div>
    </nav>

    <div class="sidebar" id="sidebar">
        <h2 style="font-size: 1.1rem; margin-bottom: 25px;">Navigasi</h2>
        <div class="nav-item" onclick="showPage('harian', 'INPUT DATA')">Beranda Utama</div>
        <div class="nav-item" onclick="showPage('bulanan', 'LAPORAN BULANAN')">Laporan Bulanan</div>
        <div class="nav-item" onclick="showPage('ekspor', 'KELOLA DATA')">Ekspor & Impor</div>
        <div class="nav-item" onclick="promptReset()" style="color: var(--brand-red); margin-top: 40px; border-top: 2px solid var(--border-light);">Hapus Semua Data</div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div class="container">
        
        <div id="page-harian" class="page active-page">
            <div class="card">
                <label>Pilih Tanggal</label>
                <input type="date" id="tgl">
                <label>Nominal Minus (Rp)</label>
                <input type="number" id="minus" placeholder="Masukkan angka..." oninput="updateHelper()">
                <div id="helper" style="font-weight:700; color:var(--success); font-size:0.9rem; margin-top:-15px; margin-bottom:20px;">Rp 0</div>
                <button class="btn-primary" onclick="simpan()">SIMPAN DATA</button>
            </div>
            <div class="card">
                <label>Riwayat Input Terbaru</label>
                <div class="scroll-container" id="recent-list"></div>
            </div>
        </div>

        <div id="page-bulanan" class="page">
            <div class="card" id="rekap-container"></div>
            <button class="btn-primary" onclick="exportExcel()">UNDUH LAPORAN EXCEL</button>
        </div>

        <div id="page-ekspor" class="page">
            <div class="card">
                <label>Kelola File Excel</label>
                <div class="nav-item" onclick="downloadTemplate()">Unduh Format (Tanggal Otomatis)</div>
                <div class="nav-item" onclick="triggerImport()">Impor / Upload File Excel</div>
                <input type="file" id="file-input" style="display:none" accept=".xlsx, .xls" onchange="importExcel(event)">
            </div>
            <div class="card">
                <label>Keamanan</label>
                <div class="nav-item" onclick="exportExcel()">Backup Seluruh Data</div>
            </div>
        </div>

    </div>

    <script>
        const DB_KEY = 'kasir_pwa_v5';
        document.getElementById('tgl').valueAsDate = new Date();

        // FUNGSI UI POP-UP CUSTOM
        function openUiModal(title, desc, buttons = []) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            const container = document.getElementById('modal-buttons');
            container.innerHTML = '';

            if (buttons.length === 0) {
                buttons = [{ text: 'Tutup', action: closeUiModal, style: 'primary' }];
            }

            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.innerText = btn.text;
                b.className = btn.style === 'primary' ? 'btn-primary' : 'btn-secondary';
                b.onclick = btn.action;
                container.appendChild(b);
            });

            document.getElementById('modal-ui').classList.add('active');
        }

        function closeUiModal() {
            document.getElementById('modal-ui').classList.remove('active');
        }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function showPage(id, title) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-' + id).classList.add('active-page');
            document.getElementById('header-title').innerText = title;
            if(id === 'harian') renderHistory();
            if(id === 'bulanan') renderBulanan();
            toggleMenu();
        }

        function updateHelper() {
            const val = document.getElementById('minus').value;
            document.getElementById('helper').innerText = "Rp " + (parseInt(val) || 0).toLocaleString('id-ID');
        }

        function simpan() {
            const tgl = document.getElementById('tgl').value;
            const amt = document.getElementById('minus').value;
            if(!amt) return openUiModal("Peringatan", "Silakan masukkan nominal nominal terlebih dahulu.");

            const data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            data.unshift({ Tanggal: tgl, Nominal: parseInt(amt) });
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            
            document.getElementById('minus').value = "";
            updateHelper();
            renderHistory();
            openUiModal("Berhasil", "Data Anda sudah tersimpan di memori lokal.");
        }

        function renderHistory() {
            const list = document.getElementById('recent-list');
            const data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            list.innerHTML = data.length ? "" : "<div style='color:var(--text-muted); font-size:0.85rem;'>Belum ada riwayat input.</div>";
            data.slice(0, 10).forEach(item => {
                list.innerHTML += `<div class="data-row"><span>${item.Tanggal}</span><span style="font-weight:700; color:var(--brand-red)">Rp ${item.Nominal.toLocaleString()}</span></div>`;
            });
        }

        function renderBulanan() {
            const container = document.getElementById('rekap-container');
            const data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            const rekap = {};
            data.forEach(item => {
                const m = new Date(item.Tanggal).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                rekap[m] = (rekap[m] || 0) + item.Nominal;
            });
            container.innerHTML = "<label>Ringkasan Laporan</label>";
            if(Object.keys(rekap).length === 0) container.innerHTML += "<div style='padding:10px 0; color:var(--text-muted);'>Tidak ada data bulanan.</div>";
            for (const [bulan, total] of Object.entries(rekap)) {
                container.innerHTML += `<div class="nav-item"><span>${bulan}</span><span style="color:var(--brand-red)">Rp ${total.toLocaleString()}</span></div>`;
            }
        }

        // EXCEL LOGIC
        function exportExcel() {
            const data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            if(!data.length) return openUiModal("Data Kosong", "Masukkan data terlebih dahulu sebelum mengunduh.");
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            XLSX.writeFile(wb, "Laporan_Kasir_Lengkap.xlsx");
        }

        function downloadTemplate() {
            const data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            let templateData = [];
            if(data.length > 0) {
                // Mengambil tanggal yang unik agar tidak dobel di template
                const uniqueDates = [...new Set(data.map(i => i.Tanggal))];
                templateData = uniqueDates.map(tgl => ({ Tanggal: tgl, Nominal: "" }));
            } else {
                templateData = [{ Tanggal: new Date().toISOString().split('T')[0], Nominal: "" }];
            }
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Input");
            XLSX.writeFile(wb, "Format_Input_Kasir.xlsx");
            openUiModal("Template Siap", "File format telah diunduh. Silakan isi angka pada kolom Nominal.");
        }

        function triggerImport() { document.getElementById('file-input').click(); }

        function importExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    if(json.length > 0) {
                        localStorage.setItem(DB_KEY, JSON.stringify(json));
                        renderHistory();
                        openUiModal("Impor Berhasil", json.length + " baris data berhasil dimasukkan.");
                    }
                } catch (err) {
                    openUiModal("Kesalahan", "Gagal membaca file. Pastikan format Excel benar.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // RESET DATA DENGAN MODAL CUSTOM
        function promptReset() {
            openUiModal(
                "Konfirmasi Hapus", 
                "Seluruh data akan dihapus permanen. Tindakan ini tidak bisa dibatalkan.",
                [
                    { text: 'Hapus Sekarang', action: () => { localStorage.removeItem(DB_KEY); location.reload(); }, style: 'primary' },
                    { text: 'Batalkan', action: closeUiModal, style: 'secondary' }
                ]
            );
        }

        renderHistory();
    </script>
</body>
</html>
